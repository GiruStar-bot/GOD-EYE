<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Africa Geopolitical Risk Tracker (Backend Connected)</title>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        :root {
            --bg-color: #0a0f1c;
            --panel-bg: rgba(10, 15, 28, 0.85);
            --panel-border: rgba(255, 255, 255, 0.1);
            --risk-critical: #ff0055; /* クリティカル */
            --risk-high: #ff4d4d;     /* 高リスク */
            --risk-medium: #ffaa00;   /* 中リスク */
            --accent-cyan: #00d2ff;
            --text-main: #e2e8f0;
            --text-sub: #94a3b8;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: var(--font-stack); background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }
        #map { width: 100%; height: 100%; position: absolute; }
        
        .maplibregl-canvas-container { filter: invert(1) hue-rotate(180deg) brightness(0.7) contrast(1.2) grayscale(0.2); background-color: #0a0f1c; }
        .maplibregl-popup, .maplibregl-marker { filter: invert(1) hue-rotate(180deg) brightness(1.4) contrast(0.8) grayscale(0); }

        .header-panel { position: absolute; top: 20px; left: 20px; z-index: 10; background: var(--panel-bg); backdrop-filter: blur(10px); padding: 1rem 1.5rem; border-radius: 8px; border: 1px solid var(--panel-border); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .header-panel h1 { margin: 0; font-size: 1.2rem; color: var(--accent-cyan); text-transform: uppercase; }
        .header-panel p { margin: 5px 0 0; font-size: 0.8rem; color: var(--text-sub); }
        
        /* サーバー接続ステータス表示 */
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 10px; vertical-align: middle; }
        .status-online { background: rgba(0, 255, 128, 0.2); color: #00ff80; border: 1px solid #00ff80; }
        .status-offline { background: rgba(255, 0, 85, 0.2); color: #ff0055; border: 1px solid #ff0055; }

        .sidebar { position: absolute; top: 20px; right: 20px; bottom: 20px; width: 320px; z-index: 10; background: var(--panel-bg); backdrop-filter: blur(10px); border-radius: 8px; border: 1px solid var(--panel-border); display: flex; flex-direction: column; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(340px); }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { margin: 0; font-size: 1rem; }
        .toggle-btn { background: none; border: 1px solid var(--panel-border); color: var(--text-main); border-radius: 4px; cursor: pointer; padding: 4px 8px; }
        
        .news-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        .news-item { padding: 1rem; border-bottom: 1px solid var(--panel-border); cursor: pointer; transition: background 0.2s; }
        .news-item:hover { background: rgba(255,255,255,0.05); }
        .news-item h3 { margin: 0 0 5px; font-size: 0.9rem; color: var(--accent-cyan); }
        .risk-tag { font-size: 0.7rem; padding: 2px 4px; border-radius: 2px; margin-right: 5px; font-weight: bold; }

        /* 動的なリスクカラー */
        .risk-Critical { color: var(--risk-critical); border: 1px solid var(--risk-critical); }
        .risk-High { color: var(--risk-high); border: 1px solid var(--risk-high); }
        .risk-Medium { color: var(--risk-medium); border: 1px solid var(--risk-medium); }

        .pulsing-dot { width: 20px; height: 20px; position: relative; cursor: pointer; }
        .pulsing-dot::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; border-radius: 50%; z-index: 2; }
        .pulsing-dot::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; border-radius: 50%; z-index: 1; animation: pulse 2s infinite; opacity: 0.5; }

        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; } }

        /* Risk Colors for Markers */
        .dot-Critical::before, .dot-Critical::after { background-color: var(--risk-critical); box-shadow: 0 0 10px var(--risk-critical); }
        .dot-High::before, .dot-High::after { background-color: var(--risk-high); box-shadow: 0 0 8px var(--risk-high); }
        .dot-Medium::before, .dot-Medium::after { background-color: var(--risk-medium); box-shadow: 0 0 5px var(--risk-medium); }

        .maplibregl-popup-content { background: var(--bg-color); color: var(--text-main); border: 1px solid var(--accent-cyan); border-radius: 4px; padding: 15px; max-width: 250px; }
        .popup-link { display: inline-block; margin-top: 8px; color: var(--accent-cyan); text-decoration: none; border: 1px solid var(--accent-cyan); padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="header-panel">
        <h1>Risk Tracker <span id="statusBadge" class="status-badge status-offline">CONNECTING...</span></h1>
        <p>Powered by FastAPI & MapLibre</p>
    </div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Live Intelligence</h2>
            <button class="toggle-btn" id="toggleSidebar">Close</button>
        </div>
        <ul class="news-list" id="newsList"><li class="news-item" style="text-align:center;">Initializing...</li></ul>
    </aside>

    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script>
        // バックエンドAPIのURL (ローカル開発用)
        const BACKEND_URL = "http://localhost:8000/api/risks";
        
        // フォールバックデータ
        const FALLBACK_DATA = {
            "type": "FeatureCollection",
            "features": [
                { "type": "Feature", "geometry": { "type": "Point", "coordinates": [31.2357, 30.0444] }, "properties": { "name": "Simulation: Cairo Alert", "risk_level": "High", "url": "#", "source": "Fallback" } },
                { "type": "Feature", "geometry": { "type": "Point", "coordinates": [3.3792, 6.5244] }, "properties": { "name": "Simulation: Lagos Incident", "risk_level": "Medium", "url": "#", "source": "Fallback" } }
            ]
        };

        const map = new maplibregl.Map({ container: 'map', style: 'https://demotiles.maplibre.org/style.json', center: [20, 0], zoom: 2.8, attributionControl: false });
        map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

        const newsListEl = document.getElementById('newsList');
        const statusBadge = document.getElementById('statusBadge');
        const sidebarEl = document.getElementById('sidebar');

        document.getElementById('toggleSidebar').addEventListener('click', () => sidebarEl.classList.add('collapsed'));

        function updateStatus(isOnline) {
            statusBadge.textContent = isOnline ? "SYSTEM ONLINE" : "OFFLINE MODE";
            statusBadge.className = isOnline ? "status-badge status-online" : "status-badge status-offline";
        }

        async function fetchData() {
            try {
                const res = await fetch(BACKEND_URL);
                if (!res.ok) throw new Error("Backend unavailable");
                const data = await res.json();
                updateStatus(true);
                return data;
            } catch (e) {
                console.warn("Backend fetch failed, using fallback:", e);
                updateStatus(false);
                return FALLBACK_DATA;
            }
        }

        async function init() {
            const geojson = await fetchData();
            newsListEl.innerHTML = '';

            geojson.features.slice(0, 50).forEach(feature => {
                const coords = feature.geometry.coordinates;
                const p = feature.properties;
                // バックエンドで付与されたリスクレベルを使用 (デフォルトはMedium)
                const risk = p.risk_level || "Medium";
                const title = p.name || "Unknown Event";

                // マーカー
                const el = document.createElement('div');
                // クラスにリスクレベルを追加して色分け
                el.className = `pulsing-dot dot-${risk}`;
                
                const marker = new maplibregl.Marker({ element: el })
                    .setLngLat(coords)
                    .setPopup(new maplibregl.Popup({ offset: 25, closeButton: false })
                    .setHTML(`<strong>${title}</strong><br><span style="color:#aaa;font-size:0.8em">Risk: ${risk}</span><br><a href="${p.url || p.htmlurl}" target="_blank" class="popup-link">Detail</a>`))
                    .addTo(map);

                // リストアイテム
                const li = document.createElement('li');
                li.className = 'news-item';
                li.innerHTML = `<h3>${title}</h3><div style="display:flex; justify-content:space-between; align-items:center"><span class="risk-tag risk-${risk}">${risk.toUpperCase()}</span><span style="font-size:0.7em; color:#888">${p.source || 'GDELT'}</span></div>`;
                li.addEventListener('click', () => {
                    map.flyTo({ center: coords, zoom: 6 });
                    marker.togglePopup();
                });
                newsListEl.appendChild(li);
            });
        }

        map.on('load', init);
    </script>
</body>
</html>
